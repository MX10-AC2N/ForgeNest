# Ce workflow est d√©clench√© manuellement (workflow_dispatch).
# L‚Äôinput `compose-dir` indique le r√©pertoire contenant le docker‚Äëcompose.yml
# pour la stack Forgejo‚ÄëWoodpecker_CI.
# Toutes les √©tapes qui utilisent Docker‚ÄëCompose utilisent
# `working-directory: ${{ env.COMPOSE_DIR }}`.

name: D√©ploiement & Tests Forgejo + Woodpecker

on:
  workflow_dispatch:
    inputs:
      compose-dir:
        description: "R√©pertoire contenant le docker‚Äëcompose.yml pour la Stack Forgejo‚ÄëWoodpecker_CI"
        required: true
        default: "./Forgejo-Woodpecker_CI-Stack"   # valeur par d√©faut

jobs:
  test-stack:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      COMPOSE_DIR: ${{ github.event.inputs.compose-dir }}

    steps:
      # -----------------------------------------------------------------
      # 1Ô∏è‚É£ Checkout du d√©p√¥t
      # -----------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------
      # 2Ô∏è‚É£ Affichage du r√©pertoire choisi (utile pour le debug)
      # -----------------------------------------------------------------
      - name: Show chosen compose directory
        run: echo "Using directory: $COMPOSE_DIR"

      # -----------------------------------------------------------------
      # 3Ô∏è‚É£ Versions Docker / Docker‚ÄëCompose
      # -----------------------------------------------------------------
      - name: Afficher les versions
        run: |
          echo "Docker version:"
          docker --version
          echo "Docker Compose version:"
          docker compose version
        working-directory: ${{ env.COMPOSE_DIR }}

      # -----------------------------------------------------------------
      # 4Ô∏è‚É£ Cr√©ation du fichier .env
      # -----------------------------------------------------------------
      - name: Cr√©er .env pour CI
        run: |
          cat <<'EOF' > .env
          FORGEJO_DOMAIN=localhost
          FORGEJO_HTTP_PORT=5333
          FORGEJO_ROOT_URL=http://localhost:5333/
          FORGEJO_SSH_PORT=5222
          FORGEJO_INTERNAL_PORT=3000
          FORGEJO_DB_TYPE=sqlite3
          FORGEJO_DB_PATH=/data/gitea/forgejo.db
          FORGEJO_MAILER_ENABLED=false
          WOODPECKER_VERSION=v2.7.1-alpine
          WOODPECKER_HOST=http://localhost:5444
          WOODPECKER_HTTP_PORT=5444
          WOODPECKER_FORGEJO=true
          WOODPECKER_FORGEJO_URL=http://forgejo:3000
          WOODPECKER_OPEN=true
          WOODPECKER_LOG_LEVEL=debug
          WOODPECKER_MAX_WORKFLOWS=2
          WOODPECKER_AGENT_SECRET=ci-test-secret-min-48-chars-DO-NOT-USE-IN-PROD-abc123def456
          ADMIN_USERNAME=forgejo-admin
          ADMIN_PASSWORD=TestPassword123!ForCIOnly
          ADMIN_EMAIL=admin@ci.local
          ADMIN_FULLNAME=CI Admin
          WOODPECKER_FORGEJO_CLIENT=
          WOODPECKER_FORGEJO_SECRET=
          VOLUMES_BASE=./volumes
          EOF
          # Supprimer les espaces √©ventuels en d√©but de ligne
          sed -i 's/^[[:space:]]*//' .env
          echo "=== .env cr√©√© ==="
          cat .env
        working-directory: ${{ env.COMPOSE_DIR }}

      # -----------------------------------------------------------------
      # 5Ô∏è‚É£ Build & Up de la stack
      # -----------------------------------------------------------------
      - name: Build la stack Docker Compose
        run: docker compose build --no-cache
        working-directory: ${{ env.COMPOSE_DIR }}

      - name: Lance la stack Docker Compose
        run: docker compose up -d
        working-directory: ${{ env.COMPOSE_DIR }}

      # -----------------------------------------------------------------
      # 6Ô∏è‚É£ Attente de la sant√© de Forgejo
      # -----------------------------------------------------------------
      - name: Attendre Forgejo healthy (max 10‚ÄØmin)
        timeout-minutes: 10
        run: |
          echo "Attente Forgejo health..."
          for i in {1..120}; do
            if curl -sf http://localhost:5333/api/healthz >/dev/null 2>&1; then
              echo "‚úÖ Forgejo healthy apr√®s ${i} tentatives ($(($i * 5))s) !"
              curl -s http://localhost:5333/api/healthz | jq . || true
              exit 0
            fi
            echo "Tentative $i/120... (sleep 5s)"
            sleep 5
          done
          echo "‚ùå Timeout Forgejo apr√®s 10‚ÄØminutes"
          docker compose logs forgejo --tail 200
          exit 1
        working-directory: ${{ env.COMPOSE_DIR }}

      # -----------------------------------------------------------------
      # 7Ô∏è‚É£ Attente de la sant√© de Woodpecker
      # -----------------------------------------------------------------
      - name: Attendre Woodpecker healthy (max 5‚ÄØmin)
        timeout-minutes: 5
        run: |
          echo "Attente Woodpecker health..."
          for i in {1..60}; do
            if curl -sf http://localhost:5444/healthz >/dev/null 2>&1; then
              echo "‚úÖ Woodpecker healthy apr√®s ${i} tentatives ($(($i * 5))s) !"
              exit 0
            fi
            echo "Tentative $i/60... (sleep 5s)"
            sleep 5
          done
          echo "‚ùå Timeout Woodpecker apr√®s 5‚ÄØminutes"
          docker compose logs woodpecker-server --tail 100
          exit 1
        working-directory: ${{ env.COMPOSE_DIR }}

      # -----------------------------------------------------------------
      # 8Ô∏è‚É£ Attente de la cr√©ation OAuth dans Forgejo
      # -----------------------------------------------------------------
      - name: Attendre la cr√©ation OAuth dans Forgejo
        timeout-minutes: 4
        run: |
          echo "üîç Poll des logs Forgejo pour confirmer la cr√©ation OAuth..."
          for i in {1..36}; do
            if docker compose logs forgejo 2>/dev/null | grep -q "first-run-init.sh termin√©"; then
              echo "‚úÖ first-run-init.sh a termin√© !"
              echo ""
              echo "--- Logs [INIT] et OAuth complets ---"
              docker compose logs forgejo 2>/dev/null |
                grep "\[INIT\]\|WOODPECKER_FORGEJO_CLIENT|WOODPECKER_FORGEJO_SECRET" |
                tail -20
              echo "--- fin ---"
              exit 0
            fi
            echo "Attente... ($(($i * 5))s)"
            sleep 5
          done
          echo ""
          echo "‚ùå Timeout : first-run-init.sh n'a pas confirm√© apr√®s 3‚ÄØmin."
          echo "--- Tous les logs Forgejo (debug) ---"
          docker compose logs forgejo --tail 100 2>/dev/null || true
          echo "--- fin ---"
          exit 1
        working-directory: ${{ env.COMPOSE_DIR }}

      # -----------------------------------------------------------------
      # 9Ô∏è‚É£ Configuration OAuth dans Woodpecker
      # -----------------------------------------------------------------
      - name: Configurer OAuth dans Woodpecker
        run: |
          echo "=== üîê Extraction des credentials OAuth depuis les logs ==="

          # Extraction robuste
          OAUTH_CLIENT=$(docker compose logs forgejo 2>/dev/null |
            grep -E "^forgejo.*WOODPECKER_FORGEJO_CLIENT=" |
            tail -n1 |
            sed 's/.*WOODPECKER_FORGEJO_CLIENT=//' |
            tr -d '\r\n' | xargs)

          OAUTH_SECRET=$(docker compose logs forgejo 2>/dev/null |
            grep -E "^forgejo.*WOODPECKER_FORGEJO_SECRET=" |
            tail -n1 |
            sed 's/.*WOODPECKER_FORGEJO_SECRET=//' |
            tr -d '\r\n' | xargs)

          echo "Client ID extrait : ${OAUTH_CLIENT:0:36}"
          echo "Secret extrait    : ${OAUTH_SECRET:0:24}..."

          # Validation basique
          if [ -z "$OAUTH_CLIENT" ] || [ -z "$OAUTH_SECRET" ]; then
            echo "‚ùå ERREUR : credentials vides apr√®s extraction"
            docker compose logs forgejo 2>/dev/null | grep -i "oauth\|init\|erreur" || true
            exit 1
          fi

          # Validation UUID (sans antislashs superflus)
          if ! echo "$OAUTH_CLIENT" | grep -qE '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'; then
            echo "‚ö†Ô∏è  ATTENTION : Le Client ID ne ressemble pas √† un UUID"
            echo "Valeur : $OAUTH_CLIENT"
          fi

          # Mise √† jour du .env
          echo "=== üìù Mise √† jour du fichier .env ==="
          sed -i "s|^WOODPECKER_FORGEJO_CLIENT=.*|WOODPECKER_FORGEJO_CLIENT=$OAUTH_CLIENT|" .env
          sed -i "s|^WOODPECKER_FORGEJO_SECRET=.*|WOODPECKER_FORGEJO_SECRET=$OAUTH_SECRET|" .env
          echo "‚úÖ .env mis √† jour :"
          grep "WOODPECKER_FORGEJO_CLIENT\|WOODPECKER_FORGEJO_SECRET" .env

          # Recr√©er le serveur Woodpecker avec les nouvelles variables
          echo "=== üîÑ Recr√©ation de Woodpecker Server avec OAuth ==="
          docker compose up -d --force-recreate woodpecker-server

          # Attente du healthcheck
          echo "Attente Woodpecker Server health..."
          for i in {1..30}; do
            if curl -sf http://localhost:5444/healthz >/dev/null 2>&1; then
              echo "‚úÖ Woodpecker healthy avec OAuth configur√© !"
              echo "=== V√©rification des variables d'environnement dans le conteneur ==="
              docker compose exec -T woodpecker-server env | grep "WOODPECKER_FORGEJO" || echo "‚ö†Ô∏è  Variables non trouv√©es"
              exit 0
            fi
            echo "Tentative $i/30... (sleep 2s)"
            sleep 2
          done
          echo "‚ùå Timeout Woodpecker apr√®s recr√©ation"
          docker compose logs woodpecker-server --tail 50
          exit 1
        working-directory: ${{ env.COMPOSE_DIR }}

      # -----------------------------------------------------------------
      # üîü Tests de validation de la stack
      # -----------------------------------------------------------------
      - name: Tests de validation
        run: |
          echo "=== üß™ Tests de validation de la stack ==="
          echo ""

          echo "Test 1/5 : Forgejo health"
          if curl -sf http://localhost:5333/api/healthz >/dev/null; then
            echo "  ‚úÖ Forgejo OK"
          else
            echo "  ‚ùå Forgejo health check failed"
            exit 1
          fi

          echo "Test 2/5 : Woodpecker health"
          if curl -sf http://localhost:5444/healthz >/dev/null; then
            echo "  ‚úÖ Woodpecker OK"
          else
            echo "  ‚ùå Woodpecker health check failed"
            exit 1
          fi

          echo "Test 3/5 : Woodpecker UI"
          if curl -sf http://localhost:5444 | grep -q "Woodpecker"; then
            echo "  ‚úÖ UI Woodpecker OK"
          else
            echo "  ‚ùå UI Woodpecker ne r√©pond pas correctement"
            exit 1
          fi

          echo "Test 4/5 : OAuth endpoint (/authorize)"
          HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:5444/authorize)
          echo "  Code HTTP /authorize : $HTTP_CODE"
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 302 ] || [ "$HTTP_CODE" -eq 303 ] || [ "$HTTP_CODE" -eq 401 ]; then
            echo "  ‚úÖ OAuth redirect OK (code valide : $HTTP_CODE)"
          else
            echo "  ‚ùå OAuth redirect failed (code inattendu : $HTTP_CODE)"
            exit 1
          fi

          echo "Test 5/5 : Variables OAuth dans Woodpecker"
          CLIENT_IN_CONTAINER=$(docker compose exec -T woodpecker-server env | grep "^WOODPECKER_FORGEJO_CLIENT=" | cut -d= -f2)
          SECRET_IN_CONTAINER=$(docker compose exec -T woodpecker-server env | grep "^WOODPECKER_FORGEJO_SECRET=" | cut -d= -f2)

          if [ -n "$CLIENT_IN_CONTAINER" ] && [ -n "$SECRET_IN_CONTAINER" ]; then
            echo "  ‚úÖ Variables OAuth pr√©sentes dans le conteneur"
            echo "     CLIENT : ${CLIENT_IN_CONTAINER:0:36}"
            echo "     SECRET : ${SECRET_IN_CONTAINER:0:24}..."
          else
            echo "  ‚ùå Variables OAuth manquantes ou vides dans le conteneur"
            echo "     CLIENT : $CLIENT_IN_CONTAINER"
            echo "     SECRET : $SECRET_IN_CONTAINER"
            exit 1
          fi

          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚úÖ TOUS LES TESTS SONT PASS√âS AVEC SUCC√àS !"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        working-directory: ${{ env.COMPOSE_DIR }}

      # -----------------------------------------------------------------
      # üìã Logs d√©taill√©s en cas d‚Äô√©chec
      # -----------------------------------------------------------------
      - name: Logs d√©taill√©s (si √©chec)
        if: failure()
        run: |
          echo "=== üîç LOGS FORGEJO ==="
          docker compose logs forgejo --tail 200 || true
          echo ""

          echo "=== üîç LOGS WOODPECKER‚ÄëSERVER ==="
          docker compose logs woodpecker-server --tail 200 || true
          echo ""

          echo "=== üîç LOGS WOODPECKER‚ÄëAGENT ==="
          docker compose logs woodpecker-agent --tail 200 || true
          echo ""

          echo "=== üìä √âTAT DES CONTENEURS ==="
          docker compose ps
          echo ""

          echo "=== üîê ENV woodpecker-server (filtr√©) ==="
          docker compose exec -T woodpecker-server env | grep -E "WOODPECKER|FORGEJO|ADMIN" | sort || true
          echo ""

          echo "=== üìÑ FICHIER .env (secrets masqu√©s) ==="
          cat .env | sed 's/$$PASSWORD\|SECRET$$=.*/\1=***/g'
          echo ""

          echo "=== üìÅ CONTENU VOLUME /shared ==="
          docker compose exec -T forgejo ls -lah /shared/ || true
          docker compose exec -T forgejo cat /shared/oauth-credentials.env 2>/dev/null || echo "Fichier oauth-credentials.env non trouv√©"
        working-directory: ${{ env.COMPOSE_DIR }}

   #  -----------------------------------------------------------------
   # üßπ Nettoyage (toujours ex√©cut√©)
   # -----------------------------------------------------------------
   - name: Nettoyage
     if: always()
     run: |
       echo "=== üßπ Nettoyage de la stack ==="
       docker compose down -v --remove-orphans || true
       docker system prune -f || true
       echo "‚úÖ Stack arr√™t√©e et volumes supprim√©s"
     working-directory: ${{ env.COMPOSE_DIR }}