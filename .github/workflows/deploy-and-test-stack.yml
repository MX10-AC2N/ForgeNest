# Ce workflow est dÃ©clenchÃ© manuellement (workflow_dispatch).
# Lâ€™input `compose-dir` indique le rÃ©pertoire contenant le dockerâ€‘compose.yml pour la stack Forgejo-Woodpecker_CI
# Toutes les Ã©tapes qui utilisent Dockerâ€‘Compose utilisent `working-directory: ${{ env.COMPOSE_DIR }}`.
name: DÃ©ploiement & Tests Forgejo + Woodpecker

on:
  workflow_dispatch:
    inputs:
      compose-dir:
        description: "RÃ©pertoire contenant le dockerâ€‘compose.yml pour la Stack Forgejo-Woodpecker_CI"
        required: true
        default: "./Forgejo-Woodpecker_CI-Stack"   # valeur par dÃ©faut

jobs:
  test-stack:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      COMPOSE_DIR: ${{ github.event.inputs.compose-dir }}
  
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show chosen compose directory
        run: echo "Using directory: $COMPOSE_DIR"

      - name: Afficher les versions
        run: |
          echo "Docker version:"
          docker --version
          echo "Docker Compose version:"
          docker compose version
        working-directory: ${{ env.COMPOSE_DIR }}

      - name: CrÃ©er .env pour CI
        run: |
          cat << 'EOF' > .env
          FORGEJO_DOMAIN=localhost
          FORGEJO_HTTP_PORT=5333
          FORGEJO_ROOT_URL=http://localhost:5333/
          FORGEJO_SSH_PORT=5222
          FORGEJO_INTERNAL_PORT=3000
          FORGEJO_DB_TYPE=sqlite3
          FORGEJO_DB_PATH=/data/gitea/forgejo.db
          FORGEJO_MAILER_ENABLED=false
          WOODPECKER_VERSION=v2.7.1-alpine
          WOODPECKER_HOST=http://localhost:5444
          WOODPECKER_HTTP_PORT=5444
          WOODPECKER_FORGEJO=true
          WOODPECKER_FORGEJO_URL=http://forgejo:3000
          WOODPECKER_OPEN=true
          WOODPECKER_LOG_LEVEL=debug
          WOODPECKER_MAX_WORKFLOWS=2
          WOODPECKER_AGENT_SECRET=ci-test-secret-min-48-chars-DO-NOT-USE-IN-PROD-abc123def456
          ADMIN_USERNAME=forgejo-admin
          ADMIN_PASSWORD=TestPassword123!ForCIOnly
          ADMIN_EMAIL=admin@ci.local
          ADMIN_FULLNAME=CI Admin
          WOODPECKER_FORGEJO_CLIENT=
          WOODPECKER_FORGEJO_SECRET=
          VOLUMES_BASE=./volumes
          EOF
          sed -i 's/^[[:space:]]*//' .env
          echo "=== .env crÃ©Ã© ==="
          cat .env
        working-directory: ${{ env.COMPOSE_DIR }}

      - name: Build la stack Docker Compose
        run: docker compose build --no-cache
        working-directory: ${{ env.COMPOSE_DIR }}

      - name: Lance la stack Docker Compose
        run: docker compose up -d
        working-directory: ${{ env.COMPOSE_DIR }}

      - name: Attendre Forgejo healthy (max 10 min)
        timeout-minutes: 10
        run: |
          echo "Attente Forgejo health..."
          for i in {1..120}; do
            if curl -sf http://localhost:5333/api/healthz >/dev/null 2>&1; then
              echo "âœ… Forgejo healthy aprÃ¨s ${i} tentatives ($(($i * 5))s) !"
              curl -s http://localhost:5333/api/healthz | jq . || true
              exit 0
            fi
            echo "Tentative $i/120... (sleep 5s)"
            sleep 5
          done
          echo "âŒ Timeout Forgejo aprÃ¨s 10 minutes"
          docker compose logs forgejo --tail 200
          exit 1
        working-directory: ${{ env.COMPOSE_DIR }}

      - name: Attendre Woodpecker healthy (max 5 min)
        timeout-minutes: 5
        run: |
          echo "Attente Woodpecker health..."
          for i in {1..60}; do
            if curl -sf http://localhost:5444/healthz >/dev/null 2>&1; then
              echo "âœ… Woodpecker healthy aprÃ¨s ${i} tentatives ($(($i * 5))s) !"
              exit 0
            fi
            echo "Tentative $i/60... (sleep 5s)"
            sleep 5
          done
          echo "âŒ Timeout Woodpecker aprÃ¨s 5 minutes"
          docker compose logs woodpecker-server --tail 100
          exit 1
        working-directory: ${{ env.COMPOSE_DIR }}

      - name: Attendre la crÃ©ation OAuth dans Forgejo
        timeout-minutes: 4
        run: |
          echo "ðŸ” Poll des logs Forgejo pour confirmer la crÃ©ation OAuth..."
          for i in {1..36}; do
            # CORRECTION: Pattern grep corrigÃ© pour matcher les logs Docker Compose
            if docker compose logs forgejo 2>/dev/null | grep -q "first-run-init.sh terminÃ©"; then
              echo "âœ… first-run-init.sh a terminÃ© !"
              echo ""
              echo "--- Logs [INIT] et OAuth complets ---"
              # CORRECTION: Pattern sans ^ pour matcher aprÃ¨s le prÃ©fixe "forgejo  | "
              docker compose logs forgejo 2>/dev/null | grep "\[INIT\]\|WOODPECKER_FORGEJO_CLIENT\|WOODPECKER_FORGEJO_SECRET" | tail -20
              echo "--- fin ---"
              exit 0
            fi
            echo "Attente... ($(($i * 5))s)"
            sleep 5
          done
          echo ""
          echo "âŒ Timeout : first-run-init.sh n'a pas confirmÃ© aprÃ¨s 3 min."
          echo "--- Tous les logs Forgejo (debug) ---"
          docker compose logs forgejo --tail 100 2>/dev/null || true
          echo "--- fin ---"
          exit 1
        working-directory: ${{ env.COMPOSE_DIR }}

      - name: Configurer OAuth dans Woodpecker
        run: |
          echo "=== ðŸ” Extraction des credentials OAuth depuis les logs ==="
          
          # AMÃ‰LIORATION: Extraction plus robuste avec validation
          OAUTH_CLIENT=$(docker compose logs forgejo 2>/dev/null | grep "^forgejo.*WOODPECKER_FORGEJO_CLIENT=" | tail -n1 | sed 's/.*WOODPECKER_FORGEJO_CLIENT=//' | tr -d '\r\n' | xargs)
          OAUTH_SECRET=$(docker compose logs forgejo 2>/dev/null | grep "^forgejo.*WOODPECKER_FORGEJO_SECRET=" | tail -n1 | sed 's/.*WOODPECKER_FORGEJO_SECRET=//' | tr -d '\r\n' | xargs)

          echo "Client ID extrait : ${OAUTH_CLIENT:0:36}"
          echo "Secret extrait    : ${OAUTH_SECRET:0:24}..."

          # Validation des credentials
          if [ -z "$OAUTH_CLIENT" ] || [ -z "$OAUTH_SECRET" ]; then
            echo "âŒ ERREUR : credentials vides aprÃ¨s extraction"
            echo ""
            echo "Logs d'initialisation complets :"
            docker compose logs forgejo 2>/dev/null | grep -i "oauth\|INIT\|ERREUR" || true
            exit 1
          fi

          # Validation format UUID pour CLIENT_ID
          if ! echo "$OAUTH_CLIENT" | grep -qE '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'; then
            echo "âš ï¸  ATTENTION : Le Client ID ne semble pas Ãªtre un UUID valide"
            echo "Valeur: $OAUTH_CLIENT"
          fi

          # Mettre Ã  jour le .env
          echo ""
          echo "=== ðŸ“ Mise Ã  jour du fichier .env ==="
          sed -i "s|^WOODPECKER_FORGEJO_CLIENT=.*|WOODPECKER_FORGEJO_CLIENT=$OAUTH_CLIENT|" .env
          sed -i "s|^WOODPECKER_FORGEJO_SECRET=.*|WOODPECKER_FORGEJO_SECRET=$OAUTH_SECRET|" .env

          echo "âœ… .env mis Ã  jour :"
          grep "WOODPECKER_FORGEJO_CLIENT\|WOODPECKER_FORGEJO_SECRET" .env

          # RecrÃ©er Woodpecker Server avec les credentials OAuth
          echo ""
          echo "=== ðŸ”„ RecrÃ©ation de Woodpecker Server avec OAuth ==="
          docker compose up -d --force-recreate woodpecker-server

          # Attendre qu'il soit healthy
          echo "Attente Woodpecker Server health..."
          for i in {1..30}; do
            if curl -sf http://localhost:5444/healthz >/dev/null 2>&1; then
              echo "âœ… Woodpecker healthy avec OAuth configurÃ© !"
              
              # VÃ©rifier que les variables sont bien chargÃ©es
              echo ""
              echo "=== VÃ©rification des variables d'environnement dans le conteneur ==="
              docker compose exec -T woodpecker-server env | grep "WOODPECKER_FORGEJO" || echo "âš ï¸  Variables non trouvÃ©es"
              
              exit 0
            fi
            echo "Tentative $i/30... (sleep 2s)"
            sleep 2
          done
          echo "âŒ Timeout Woodpecker aprÃ¨s recrÃ©ation"
          docker compose logs woodpecker-server --tail 50
          exit 1
        working-directory: ${{ env.COMPOSE_DIR }}

      - name: Tests de validation
        run: |
          echo "=== ðŸ§ª Tests de validation de la stack ==="
          echo ""
          
          echo "Test 1/5: Forgejo health"
          if curl -sf http://localhost:5333/api/healthz >/dev/null; then
            echo "  âœ… Forgejo OK"
          else
            echo "  âŒ Forgejo health check failed"
            exit 1
          fi

          echo ""
          echo "Test 2/5: Woodpecker health"
          if curl -sf http://localhost:5444/healthz >/dev/null; then
            echo "  âœ… Woodpecker OK"
          else
            echo "  âŒ Woodpecker health check failed"
            exit 1
          fi

          echo ""
          echo "Test 3/5: Woodpecker UI"
          if curl -sf http://localhost:5444 | grep -q "Woodpecker"; then
            echo "  âœ… UI Woodpecker OK"
          else
            echo "  âŒ UI Woodpecker ne rÃ©pond pas correctement"
            exit 1
          fi

          echo ""
          echo "Test 4/5: OAuth endpoint (/authorize)"
          HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:5444/authorize)
          echo "  Code HTTP /authorize : $HTTP_CODE"
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 302 ] || [ "$HTTP_CODE" -eq 303 ] || [ "$HTTP_CODE" -eq 401 ]; then
            echo "  âœ… OAuth redirect OK (code valide: $HTTP_CODE)"
          else
            echo "  âŒ OAuth redirect failed (code inattendu: $HTTP_CODE)"
            exit 1
          fi

          echo ""
          echo "Test 5/5: Variables OAuth dans Woodpecker"
          CLIENT_IN_CONTAINER=$(docker compose exec -T woodpecker-server env | grep "^WOODPECKER_FORGEJO_CLIENT=" | cut -d= -f2)
          SECRET_IN_CONTAINER=$(docker compose exec -T woodpecker-server env | grep "^WOODPECKER_FORGEJO_SECRET=" | cut -d= -f2)
          
          if [ -n "$CLIENT_IN_CONTAINER" ] && [ -n "$SECRET_IN_CONTAINER" ]; then
            echo "  âœ… Variables OAuth prÃ©sentes dans le conteneur"
            echo "     CLIENT: ${CLIENT_IN_CONTAINER:0:36}"
            echo "     SECRET: ${SECRET_IN_CONTAINER:0:24}..."
          else
            echo "  âŒ Variables OAuth manquantes ou vides dans le conteneur"
            echo "     CLIENT: $CLIENT_IN_CONTAINER"
            echo "     SECRET: $SECRET_IN_CONTAINER"
            exit 1
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… TOUS LES TESTS SONT PASSÃ‰S AVEC SUCCÃˆS !"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        working-directory: ${{ env.COMPOSE_DIR }}

      - name: Logs dÃ©taillÃ©s (si Ã©chec)
        if: failure()
        run: |
          echo "=========================================="
          echo "=== ðŸ” LOGS FORGEJO ==="
          echo "=========================================="
          docker compose logs forgejo --tail 200 || true
          echo ""
          echo "=========================================="
          echo "=== ðŸ” LOGS WOODPECKER-SERVER ==="
          echo "=========================================="
          docker compose logs woodpecker-server --tail 200 || true
          echo ""
          echo "=========================================="
          echo "=== ðŸ” LOGS WOODPECKER-AGENT ==="
          echo "=========================================="
          docker compose logs woodpecker-agent --tail 200 || true
          echo ""
          echo "=========================================="
          echo "=== ðŸ“Š Ã‰TAT DES CONTENEURS ==="
          echo "=========================================="
          docker compose ps
          echo ""
          echo "=========================================="
          echo "=== ðŸ” ENV woodpecker-server (filtrÃ©) ==="
          echo "=========================================="
          docker compose exec -T woodpecker-server env | grep -E "WOODPECKER|FORGEJO|ADMIN" | sort || true
          echo ""
          echo "=========================================="
          echo "=== ðŸ“„ FICHIER .env (secrets masquÃ©s) ==="
          echo "=========================================="
          cat .env | sed 's/\(PASSWORD\|SECRET\)=.*/\1=***/g'
          echo ""
          echo "=========================================="
          echo "=== ðŸ“ CONTENU VOLUME /shared ==="
          echo "=========================================="
          docker compose exec -T forgejo ls -lah /shared/ || true
          docker compose exec -T forgejo cat /shared/oauth-credentials.env 2>/dev/null || echo "Fichier oauth-credentials.env non trouvÃ©"
        working-directory: ${{ env.COMPOSE_DIR }}

      - name: Nettoyage
        if: always()
        run: |
          echo "=== ðŸ§¹ Nettoyage ==="
          docker compose down -v
          echo "âœ… Stack arrÃªtÃ©e et volumes supprimÃ©s"
        working-directory: ${{ env.COMPOSE_DIR }}
